<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Feign源码分析 -</title><meta name=keywords content="zyg,独立,博客,程序员,个人,思考,读书,笔记,技术,分享,java"><meta property="og:title" content="Feign源码分析"><meta property="og:site_name" content><meta property="og:image" content="/img/author.jpg"><meta name=title content="Feign源码分析 -"><meta name=description content="zyg | 博客 | 软件 |  Java"><link rel="shortcut icon" href=https://1162492411.github.io/docs/img/favicon.ico><link rel=apple-touch-icon href=https://1162492411.github.io/docs/img/apple-touch-icon.png><link rel=apple-touch-icon-precomposed href=https://1162492411.github.io/docs/img/apple-touch-icon.png><link href="https://1162492411.github.io/docs/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel=stylesheet type=text/css><link href="https://1162492411.github.io/docs/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel=stylesheet type=text/css><link href=https://1162492411.github.io/docs/css/main.css rel=stylesheet type=text/css><link href=https://1162492411.github.io/docs/css/syntax.css rel=stylesheet type=text/css><script type=text/javascript id=hexo.configuration>var NexT=window.NexT||{};var CONFIG={scheme:'Pisces',sidebar:{"position":"left","display":"post"},fancybox:true,motion:true};</script></head><body itemscope itemtype=http://schema.org/WebPage lang=zh-hans><div class="container one-collumn sidebar-position-left page-home"><div class=headband></div><header id=header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class="site-meta custom-logo"><div class=custom-logo-site-title><a href=https://1162492411.github.io/docs/ class=brand rel=start><span class=logo-line-before><i></i></span><span class=site-title></span><span class=logo-line-after><i></i></span></a></div><p class=site-subtitle>人生天地间，忽如远行客</p></div><div class=site-nav-toggle><button>
<span class=btn-bar></span><span class=btn-bar></span><span class=btn-bar></span></button></div><nav class=site-nav><ul id=menu class=menu><li class=menu-item><a href=https://1162492411.github.io/docs/ rel=section><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class=menu-item><a href=https://1162492411.github.io/docs/categories/%E6%8A%80%E6%9C%AF/ rel=section><i class="menu-item-icon fa fa-fw fa-code"></i><br>技术</a></li><li class=menu-item><a href=https://1162492411.github.io/docs/categories/%E5%AE%9E%E6%88%98/ rel=section><i class="menu-item-icon fa fa-fw fa-code"></i><br>实战</a></li><li class=menu-item><a href=https://1162492411.github.io/docs/categories/%E7%AC%94%E8%AE%B0/ rel=section><i class="menu-item-icon fa fa-fw fa-book"></i><br>笔记</a></li><li class=menu-item><a href=https://1162492411.github.io/docs/categories/%E9%9D%A2%E8%AF%95%E9%A2%98/ rel=section><i class="menu-item-icon fa fa-fw fa-leaf"></i><br>面试题</a></li><li class=menu-item><a href=https://1162492411.github.io/docs/post/ rel=section><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class=menu-item><a href=https://1162492411.github.io/docs/about/ rel=section><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-search"><a href=javascript:; class=popup-trigger><i class="menu-item-icon fa fa-search fa-fw"></i><br></a></li></ul><div class=site-search><div class=popup><span class="search-icon fa fa-search"></span><input type=text id=local-search-input><div id=local-search-result></div><span class=popup-btn-close>close</span></div></div></nav></div></header><main id=main class=main><div class=main-inner><div class=content-wrap><div id=content class=content><section id=posts class=posts-expand><article class="post post-type-normal" itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline"><a class=post-title-link href=https://1162492411.github.io/docs/post/feign%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ itemprop=url>Feign源码分析</a></h1><div class=post-meta><span class=post-time><span class=post-meta-item-icon><i class="fa fa-calendar-o"></i></span><span class=post-meta-item-text></span><time itemprop=dateCreated datetime=2016-03-22T13:04:35+08:00 content="2022-01-17">2022-01-17</time></span>
<span class=post-category>&nbsp; | &nbsp;
<span class=post-meta-item-icon><i class="fa fa-folder-o"></i></span><span class=post-meta-item-text></span><span itemprop=about itemscope itemtype=https://schema.org/Thing><a href=https://1162492411.github.io/docs/categories/feign itemprop=url rel=index><span itemprop=name>Feign</span></a>
&nbsp;</span></span>
<span>&nbsp; | &nbsp;
<span class=post-meta-item-icon><i class="fa fa-eye"></i></span><span class=post-meta-item-text></span><span class=leancloud-visitors-count></span></span></div></header><div class=post-body itemprop=articleBody><h1 id=feign源码分析-初始化流程和执行流程>Feign源码分析-初始化流程和执行流程</h1><h2 id=概述>概述</h2><p>Feign<code>是一个面向对象的</code>http<code>客户端, 这里主要介绍</code>Feign<code>是如何初始化的, 并如何进行</code>http<code>请求的. 省略部分不重要的代码. 剥离了</code>hystrix<code>和</code>ribbon`的相关逻辑.</p><p>Feign大致经历了以下的发展历程</p><blockquote><p>Feign : Netflix开源维护的声明式REST客户端</p><p>spring-cloud-feign ：Spring-Cloud-1.x基于Feign，支持SpringMvc注解</p><p>OpenFeign ：Netflix不再维护Feign，交由社区维护，更名为OpenFeign</p><p>spring-cloud-openfeign ：Spring-Cloud-2.x基于OpenFeign，支持SpringMvc注解</p></blockquote><h2 id=使用方式>使用方式</h2><h3 id=1引入框架依赖>1.引入框架依赖</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#f92672>&lt;dependency&gt;</span>
     <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.cloud<span style=color:#f92672>&lt;/groupId&gt;</span>
     <span style=color:#f92672>&lt;artifactId&gt;</span>spring-cloud-starter-openfeign<span style=color:#f92672>&lt;/artifactId&gt;</span>
<span style=color:#f92672>&lt;/dependency&gt;</span>
</code></pre></div><h3 id=2开启feign功能>2.开启feign功能</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>//在启动类添加@EnableFeignClients注解
</span><span style=color:#75715e></span><span style=color:#a6e22e>@EnableFeignClients</span>
<span style=color:#a6e22e>@SpringBootApplication</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ConsumerApplication</span> <span style=color:#f92672>{</span>
    <span style=color:#75715e>//....       
</span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</code></pre></div><h3 id=3定义业务client>3.定义业务Client</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>//业务client
</span><span style=color:#75715e></span><span style=color:#a6e22e>@FeignClient</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;businessA-client&#34;</span><span style=color:#f92672>,</span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http://localhost:8081/service-a.address&#34;</span><span style=color:#f92672>,</span> configuration<span style=color:#f92672>=</span>BusinessAFeignConfiguration<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>BusinessAFeignClient</span> <span style=color:#f92672>{</span>

    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/v1/user/{id}&#34;</span><span style=color:#f92672>)</span>
    ResponseEntity<span style=color:#f92672>&lt;</span>User<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getUserById</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@PathVariable</span> Long id<span style=color:#f92672>,</span> <span style=color:#a6e22e>@RequestParam</span><span style=color:#f92672>(</span>required <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>)</span> String name<span style=color:#f92672>);</span>

    <span style=color:#a6e22e>@PostMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/v1/user&#34;</span><span style=color:#f92672>)</span>
    ResponseEntity<span style=color:#f92672>&lt;</span>User<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>createUser</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestBody</span> User user<span style=color:#f92672>);</span>

<span style=color:#f92672>}</span>

<span style=color:#75715e>//业务client的feign配置类
</span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BusinessAFeignConfiguration</span> <span style=color:#f92672>{</span>

    <span style=color:#a6e22e>@Bean</span>
    Retryer <span style=color:#a6e22e>feignRetryer</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> Retryer<span style=color:#f92672>.</span><span style=color:#a6e22e>NEVER_RETRY</span><span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Bean</span>
    Request<span style=color:#f92672>.</span><span style=color:#a6e22e>Options</span> <span style=color:#a6e22e>requestOptions</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>int</span> ribbonReadTimeout <span style=color:#f92672>=</span> 2000<span style=color:#f92672>;</span>
        <span style=color:#66d9ef>int</span> ribbonConnectionTimeout <span style=color:#f92672>=</span> 500<span style=color:#f92672>;</span>
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Request<span style=color:#f92672>.</span><span style=color:#a6e22e>Options</span><span style=color:#f92672>(</span>ribbonConnectionTimeout<span style=color:#f92672>,</span> ribbonReadTimeout<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h3 id=4使用业务client>4.使用业务Client</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@RestController</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FeignController</span> <span style=color:#f92672>{</span>
  
  	<span style=color:#75715e>//注入AFeignClient
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>@Autowired</span>
    <span style=color:#66d9ef>private</span> BusinessAFeignClient aFeignClient<span style=color:#f92672>;</span>

    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/v1/user/query&#34;</span><span style=color:#f92672>)</span>
    <span style=color:#66d9ef>public</span> ResponseEntity<span style=color:#f92672>&lt;</span>User<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>queryUser</span><span style=color:#f92672>(</span>Long id<span style=color:#f92672>,</span>String name<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#75715e>//调用AFeignClient的方法
</span><span style=color:#75715e></span>        User user <span style=color:#f92672>=</span> aFeignClient<span style=color:#f92672>.</span><span style=color:#a6e22e>getUserById</span><span style=color:#f92672>(</span>id<span style=color:#f92672>,</span>name<span style=color:#f92672>);</span>
        <span style=color:#66d9ef>return</span> ResponseEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>ok</span><span style=color:#f92672>(</span>user<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

<span style=color:#f92672>}</span>
</code></pre></div><h2 id=初始化流程>初始化流程</h2><h3 id=流程概览>流程概览</h3><p>在feign的调用过程中，针对不同的服务为其创建一个上下文，我们可以将这个上下文理解为沙箱。执行调用所需要的资源是从各自的沙箱环境中取。整体的职责分工如下图所示</p><p><img src=https://gitee.com/1162492411/pic/raw/master/image-20220117220527611.png alt=image-20220117220527611></p><h3 id=扫描注册子流程>扫描注册子流程</h3><p>​ 通过前面的DEMO可以发现，使用 Feign 最核心的应该就是 @EnableFeignClients 和 @FeignClient 这两个注解，@FeignClient 加在客户端接口类上，@EnableFeignClients 加在启动类上，就是用来扫描加了 @FeignClient 接口的类。我们研究源码就从这两个入口开始。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@Import</span><span style=color:#f92672>(</span>FeignClientsRegistrar<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#75715e>// 引入 FeignClientsRegistrar
</span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>@interface</span> EnableFeignClients <span style=color:#f92672>{</span>
  <span style=color:#f92672>...</span>
<span style=color:#f92672>}</span>
</code></pre></div><p><code>@EnableFeignClients</code>注解引入了<code>FeignClientsRegistrar</code>, 类实现了<code>ImportBeanDefinitionRegistrar</code>接口, 然后重写了<code>registerBeanDefinitions</code>方法.
说明加入到了<code>Spring</code>生命周期的管理中.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>// org.springframework.cloud.openfeign.FeignClientsRegistrar
</span><span style=color:#75715e>// 实现了 ImportBeanDefinitionRegistrar 接口, 注册到 Spring 生命周期中
</span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FeignClientsRegistrar</span> <span style=color:#66d9ef>implements</span> ImportBeanDefinitionRegistrar<span style=color:#f92672>,</span> ResourceLoaderAware<span style=color:#f92672>,</span> EnvironmentAware <span style=color:#f92672>{</span>
    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>registerBeanDefinitions</span><span style=color:#f92672>(</span>AnnotationMetadata metadata<span style=color:#f92672>,</span> BeanDefinitionRegistry registry<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#75715e>// 1. 注册全局默认feign配置
</span><span style=color:#75715e></span>        registerDefaultConfiguration<span style=color:#f92672>(</span>metadata<span style=color:#f92672>,</span> registry<span style=color:#f92672>);</span>
        <span style=color:#75715e>// 2. 创建 FeignClientFactoryBean 注入到 Spring 容器中
</span><span style=color:#75715e></span>        registerFeignClients<span style=color:#f92672>(</span>metadata<span style=color:#f92672>,</span> registry<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h4 id=注册全局默认feign配置>注册全局默认feign配置</h4><p>registerDefaultConfiguration()方法比较简单，这里直接给出文字版逻辑:</p><ul><li>获取 EnableFeignClients 中的属性</li><li>注册一个 default.类名.FeignClientSpecification 的 Bean, 作为默认Feign配置</li></ul><h4 id=注册feignclientfactorybean>注册FeignClientFactoryBean</h4><p>逻辑如下</p><ul><li>准备扫描路径列表 : 根据 @EnableFeignClients 的 clients 属性或者 value、basePackages、basePackageClasses 属性初始化 basePackages 变量</li><li>准备扫描器，并添加过滤，只扫描 @FeignClient 注解修饰的类</li><li>for循环basePackages<ul><li>扫描包下的所有被 @FeignClient 注解修饰的接口</li><li>获取@FeignClient注解上的值</li><li>获取name : 按 contextId、value、name、serviceId 的优先级顺序获取 name, 用来做下面 bean name 的前缀${name}</li><li>注册feignConfigraution到spring core ：注册为${name}.FeignClientSpecification</li><li>注册FeignClientFactoryBean到spring core : com.xxx.AClient(别名 ${name}FeignClient)</li></ul></li></ul><h4 id=扫描注册一图流>扫描注册一图流</h4><p><img src=https://gitee.com/1162492411/pic/raw/master/Feign-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E6%B3%A8%E5%86%8C%E6%B5%81%E7%A8%8B%E4%B8%80%E5%9B%BE%E6%B5%81.png alt=image-20220117220742515></p><h3 id=生成动态代理子流程>生成动态代理子流程</h3><p>​ FeignClientFactoryBean 实现了 FactoryBean 接口，当一个Bean实现了 FactoryBean 接口后，Spring 会先实例化这个工厂，然后调用 getObject() 创建真正的Bean。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FeignClientFactoryBean</span> <span style=color:#66d9ef>implements</span> FactoryBean<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;,</span> InitializingBean<span style=color:#f92672>,</span> ApplicationContextAware <span style=color:#f92672>{</span>
 <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>getObject</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
        <span style=color:#75715e>//核心代码
</span><span style=color:#75715e></span>        FeignContext context <span style=color:#f92672>=</span> applicationContext<span style=color:#f92672>.</span><span style=color:#a6e22e>getBean</span><span style=color:#f92672>(</span>FeignContext<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
        Feign<span style=color:#f92672>.</span><span style=color:#a6e22e>Builder</span> builder <span style=color:#f92672>=</span> feign<span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
        Client client <span style=color:#f92672>=</span> getOptional<span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> Client<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
        builder<span style=color:#f92672>.</span><span style=color:#a6e22e>client</span><span style=color:#f92672>(</span>client<span style=color:#f92672>);</span>
        Targeter targeter <span style=color:#f92672>=</span> get<span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> Targeter<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
        <span style=color:#66d9ef>return</span> targeter<span style=color:#f92672>.</span><span style=color:#a6e22e>target</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> builder<span style=color:#f92672>,</span> context<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> HardCodedTarget<span style=color:#f92672>&lt;&gt;(</span>
                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>type</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>name</span><span style=color:#f92672>,</span> url<span style=color:#f92672>));</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h4 id=核心组件>核心组件</h4><p>在该子流程中,涉及到以下核心组件</p><ul><li>FeignContext : 作用是隔离不同服务的各种feign组件,创建一个沙箱环境</li><li>Feign.Builder : 作用是准备好每个FeignClient所需要的各种feign配置组件(借助sring存储在不同的springContext),设置了 Logger、Encoder、Decoder、Contract&mldr;.，并读取配置文件中 feign.client.* 相关的配置</li><li>Client : 作用是完成http请求，目前有以下实现类<ul><li>Default ： 默认实现，使用HttpURLConnection</li><li>Proxied : https实现，使用HttpURLConnection</li><li>FeignBlockingLoadBalancerClient ： 负载均衡实现，使用ribbon load balance</li><li>RetryableFeignBlockingLoadBalancerClient ：负载均衡+重试实现，使用spring cloud load balance</li></ul></li><li>Target : 作用是桥接不同的动态代理实现类,现在有<code>DefaultTargeter</code>和<code>HystrixTargeter</code></li><li>Feign : 作用是生成代理类并借助java生成代理关系,目前有ReflectiveFeign，<strong>在这里注入了properties</strong></li><li>Map&lt;Method,MethodHandler> dispatchMap : 实际请求时通过该数据进行路由</li></ul><h4 id=生成代理一图流>生成代理一图流</h4><p><img src=https://gitee.com/1162492411/pic/raw/master/Feign-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E7%94%9F%E6%88%90%E4%BB%A3%E7%90%86%E6%B5%81%E7%A8%8B.png alt=image-20220117220849995></p><h4 id=代理关系核心代码>代理关系核心代码</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>//1.Feign.newInstance()具体逻辑
</span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ReflectiveFeign</span> <span style=color:#66d9ef>extends</span> Feign <span style=color:#f92672>{</span>
   <span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> T <span style=color:#a6e22e>newInstance</span><span style=color:#f92672>(</span>Target<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> target<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    <span style=color:#75715e>//feign自己的内部关系 
</span><span style=color:#75715e></span>    Map<span style=color:#f92672>&lt;</span>Method<span style=color:#f92672>,</span> MethodHandler<span style=color:#f92672>&gt;</span> methodToHandler <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LinkedHashMap<span style=color:#f92672>&lt;</span>Method<span style=color:#f92672>,</span> MethodHandler<span style=color:#f92672>&gt;();</span>
    <span style=color:#75715e>//借助java反射维护的关系
</span><span style=color:#75715e></span>    List<span style=color:#f92672>&lt;</span>DefaultMethodHandler<span style=color:#f92672>&gt;</span> defaultMethodHandlers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LinkedList<span style=color:#f92672>&lt;</span>DefaultMethodHandler<span style=color:#f92672>&gt;();</span>
	  <span style=color:#75715e>//在factory.create中将fein的invocationHandler注入进去
</span><span style=color:#75715e></span>    InvocationHandler handler <span style=color:#f92672>=</span> factory<span style=color:#f92672>.</span><span style=color:#a6e22e>create</span><span style=color:#f92672>(</span>target<span style=color:#f92672>,</span> methodToHandler<span style=color:#f92672>);</span>
    <span style=color:#75715e>//借助java反射实现代理拦截效果
</span><span style=color:#75715e></span>    T proxy <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>T<span style=color:#f92672>)</span> Proxy<span style=color:#f92672>.</span><span style=color:#a6e22e>newProxyInstance</span><span style=color:#f92672>(</span>target<span style=color:#f92672>.</span><span style=color:#a6e22e>type</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getClassLoader</span><span style=color:#f92672>(),</span>
        <span style=color:#66d9ef>new</span> Class<span style=color:#f92672>&lt;?&gt;[]</span> <span style=color:#f92672>{</span>target<span style=color:#f92672>.</span><span style=color:#a6e22e>type</span><span style=color:#f92672>()},</span> handler<span style=color:#f92672>);</span>
    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>DefaultMethodHandler defaultMethodHandler <span style=color:#f92672>:</span> defaultMethodHandlers<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
      defaultMethodHandler<span style=color:#f92672>.</span><span style=color:#a6e22e>bindTo</span><span style=color:#f92672>(</span>proxy<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
    <span style=color:#66d9ef>return</span> proxy<span style=color:#f92672>;</span>
  <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
<span style=color:#75715e>//factory.create()具体逻辑
</span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>InvocationHandlerFactory</span> <span style=color:#f92672>{</span>
  <span style=color:#75715e>//调用这里
</span><span style=color:#75715e></span>  InvocationHandler <span style=color:#a6e22e>create</span><span style=color:#f92672>(</span>Target target<span style=color:#f92672>,</span> Map<span style=color:#f92672>&lt;</span>Method<span style=color:#f92672>,</span> MethodHandler<span style=color:#f92672>&gt;</span> dispatch<span style=color:#f92672>);</span>

  <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>MethodHandler</span> <span style=color:#f92672>{</span>

    Object <span style=color:#a6e22e>invoke</span><span style=color:#f92672>(</span>Object<span style=color:#f92672>[]</span> argv<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Throwable<span style=color:#f92672>;</span>
  <span style=color:#f92672>}</span>

  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Default</span> <span style=color:#66d9ef>implements</span> InvocationHandlerFactory <span style=color:#f92672>{</span>
    <span style=color:#75715e>//最终调用到这里
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> InvocationHandler <span style=color:#a6e22e>create</span><span style=color:#f92672>(</span>Target target<span style=color:#f92672>,</span> Map<span style=color:#f92672>&lt;</span>Method<span style=color:#f92672>,</span> MethodHandler<span style=color:#f92672>&gt;</span> dispatch<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ReflectiveFeign<span style=color:#f92672>.</span><span style=color:#a6e22e>FeignInvocationHandler</span><span style=color:#f92672>(</span>target<span style=color:#f92672>,</span> dispatch<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
  <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h2 id=处理请求流程>处理请求流程</h2><p>​ feign的设计思路是在初始化流程中生成业务Client和业务Client的动态代理类的绑定关系,那么当代码调用到业务Client方法时,便会转向调用代理类的方法。</p><h4 id=处理请求核心代码>处理请求核心代码</h4><p>上文分析到最终在ReflectiveFeign中生成了代理，那么处理请求时就会调用到该类的invoke()</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FeignInvocationHandler</span> <span style=color:#66d9ef>implements</span> InvocationHandler <span style=color:#f92672>{</span>
  <span style=color:#75715e>//这个在初始化流程中准备好了关系
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Map<span style=color:#f92672>&lt;</span>Method<span style=color:#f92672>,</span> MethodHandler<span style=color:#f92672>&gt;</span> dispatch<span style=color:#f92672>;</span>
 <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>invoke</span><span style=color:#f92672>(</span>Object proxy<span style=color:#f92672>,</span> Method method<span style=color:#f92672>,</span> Object<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Throwable <span style=color:#f92672>{</span>
      <span style=color:#66d9ef>return</span> dispatch<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>method<span style=color:#f92672>).</span><span style=color:#a6e22e>invoke</span><span style=color:#f92672>(</span>args<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>  
</code></pre></div><p>​ 在dispatch中注册进的MethodHandler实际为SynchronousMethodHandler</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SynchronousMethodHandler</span> <span style=color:#66d9ef>implements</span> MethodHandler<span style=color:#f92672>{</span>
    <span style=color:#a6e22e>@Override</span>
  <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>invoke</span><span style=color:#f92672>(</span>Object<span style=color:#f92672>[]</span> argv<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Throwable <span style=color:#f92672>{</span>
    <span style=color:#75715e>/**
</span><span style=color:#75715e>    1.根据请求参数构建请求模板 RequestTemplate，这个时候会处理参数中的占位符、拼接请求参数、处理body中的参数等等。
</span><span style=color:#75715e>    2.将 RequestTemplate 转成 Request : 
</span><span style=color:#75715e>      2.1 用 RequestInterceptor 处理请求模板
</span><span style=color:#75715e>      2.2 用 Target（HardCodedTarget）处理请求地址，拼接上服务名前缀
</span><span style=color:#75715e>      2.3 调用 RequestTemplate 的 request 方法获取到 Request 对象
</span><span style=color:#75715e>    3. 调用 LoadBalancerFeignClient 的 execute 方法来执行请求并得到请求结果 Response
</span><span style=color:#75715e>    4. 得到 Response 后，就使用解码器 Decoder 解析响应结果，返回接口方法定义的返回类型
</span><span style=color:#75715e>    */</span>
  <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h4 id=处理请求一图流>处理请求一图流</h4><p><img src=https://gitee.com/1162492411/pic/raw/master/Feign-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82%E4%B8%80%E5%9B%BE%E6%B5%81.png alt=image-20220117221035060></p><p><img src=https://gitee.com/1162492411/pic/raw/master/Feign-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82%E6%A6%82%E8%A7%88.png alt=image-20220117221221585></p><h2 id=对象关系>对象关系</h2><p>${beanName} : 从@FeignClient注解中按优先级查找context-id/service-id/name/value的值</p><p><img src=https://gitee.com/1162492411/pic/raw/master/feign-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%AF%B9%E8%B1%A1%E5%85%B3%E7%B3%BB.png alt=image-20220125211131866></p><h2 id=日常开发问题>日常开发问题</h2><h3 id=q--feignclients中的名字能否一致如果一致会出现什么问题>Q : @FeignClients中的名字能否一致？如果一致会出现什么问题</h3><p>A : cloudOpenFeign中存在多个name，name有三种：一种是注册到spring的beanName(从context-id/service-id/name/value取值)，一种是注册到spring的bean的别名aliasName(从qualifiers/qualifier取值)，还有一种name是class的全路径className,这三个名字(beanName,aliasName,className)不仅用于FeignClient自身向spring注册，还用于它专属的Configuration、Options等组件的spring bean名称。因此是否可以重复实际上取决于spring bean配置spring.main.allow-bean-definition-overriding，</p><ul><li><code>Spring Boot 2.0.x</code> 默认是 <code>true</code>.</li><li><code>Spring Boot 2.1.x</code> 默认是 <code>false</code></li></ul><h3 id=q-报错出现重复的feignclientspecification如何解决>Q ：报错"出现重复的FeignClientSpecification"如何解决</h3><p>A : 检查@FeignClient中是否存在相同的context-id/service-id/name/value</p><h3 id=q--报错ambiguousmapping如何解决>Q : 报错"AmbiguousMapping"如何解决</h3><p>A : 原因是xxxClient继承不同服务的xxApi时，xxxApi类级别存在@RequestMapping注解，xxxClient继承后也被springmvc扫描了</p><p>解决方案：1）自定义一个RequestMappingHandlerMapping重写isHandler()方法；2）升级到spring6； 3）升级到cloudOpenFeign v3.1.0 v3.0.6 v3.0.5 v2.2.10.RELEASE</p><h3 id=q--如何配置使用http连接池它们是怎么生效的>Q ： 如何配置使用HTTP连接池？它们是怎么生效的</h3><p>A : 配置连接池需要两步：1)property配置feign.httpclient.enabled= true 2）maven引入依赖
生效方式方面，主要是feign-client中先进行了client的注册，这样在feign初始化时整个项目的spring中存在了client，被各个feignClient拿去使用</p><h3 id=q-默认超时配置是多少>Q ：默认超时配置是多少？</h3><p>A : 默认是连接超时10s，读超时60s,通过feign.Request.Options()空参构造器实现</p><ul><li>可以配置一个全局超时时间 ：feign.client.config. default.connectTimeout= 2000 feign.client.config. default.readTimeout= 60000</li><li>可以单独对指定FeignClient配置超时时间 : 1)代码配置 @FeignClient(configuration=xxx.config.class) config类中声明options 2）配置文件配置 feign.client.config.serviceC.connectTimeout=2000 feign.client.config.serviceC.readTimeout=60000</li><li>feign和robbin等的超时时间优先级：需要实验一下，一方面,robbin有自己的client,一方面ribbon相关的包可能会先注册options对象从而影响feign的初始化流程</li></ul><h3 id=q-feignclient的配置优先级>Q ：feignClient的配置优先级？</h3><p>A : FeignClientFactoryBean.configureFeign()中进行了配置的准备,得出的结论是</p><p>如果feign.client.defaultToProperties=true(默认,属性默认赋值为true),生效顺序是全局上下文->默认上下文→指定FeignClient上下文</p><p>如果feign.client.defaultToProperties=false,生效顺序是默认上下文->指定FeignClient上下文->全局上下文</p></div><footer class=post-footer><div class=post-tags><a href=https://1162492411.github.io/docs/tags/java rel=tag title=Java>#Java#</a>
<a href=https://1162492411.github.io/docs/tags/feign rel=tag title=Feign>#Feign#</a>
<a href=https://1162492411.github.io/docs/tags/%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90 rel=tag title=源码分析>#源码分析#</a></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=https://1162492411.github.io/docs/post/mapstruct%E7%AE%80%E8%A6%81%E6%8C%87%E5%8D%97/ rel=next title=MapStruct简要指南><i class="fa fa-chevron-left"></i>MapStruct简要指南</a></div><div class="post-nav-prev post-nav-item"><a href=https://1162492411.github.io/docs/post/feignambiguousmapping%E9%87%8D%E5%A4%8D%E6%98%A0%E5%B0%84%E9%97%AE%E9%A2%98/ rel=prev title=FeignAmbiguousMapping重复映射问题>FeignAmbiguousMapping重复映射问题 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></section></div></div><div class=sidebar-toggle><div class=sidebar-toggle-line-wrap><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id=sidebar class=sidebar><div class=sidebar-inner><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target=post-toc-wrap></li><li class=sidebar-nav-overview data-target=site-overview></li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image src=https://1162492411.github.io/docs/img/author.jpg alt=zyg><p class=site-author-name itemprop=name>zyg</p><p class="site-description motion-element" itemprop=description>Programmer & Architect</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href=https://1162492411.github.io/docs/post/><span class=site-state-item-count>28</span>
<span class=site-state-item-name></span></a></div><div class="site-state-item site-state-categories"><a href=https://1162492411.github.io/docs/categories/><span class=site-state-item-count>27</span>
<span class=site-state-item-name></span></a></div><div class="site-state-item site-state-tags"><a href=https://1162492411.github.io/docs/tags/><span class=site-state-item-count>47</span>
<span class=site-state-item-name></span></a></div></nav><div class="links-of-author motion-element"><span class=links-of-author-item><a href=https://github.com/1162492411/ target=_blank title=GitHub><i class="fa fa-fw fa-github"></i>GitHub</a></span></div><div class="links-of-blogroll motion-element inline"><script type=text/javascript src="//rf.revolvermaps.com/0/0/8.js?i=5b4f2ucxar6&m=0&s=220&c=ff0000&cr1=ffffff&f=arial&l=33&bv=35" async></script></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class=post-toc><div class=post-toc-content><nav id=TableOfContents><ul><li><a href=#概述>概述</a></li><li><a href=#使用方式>使用方式</a><ul><li><a href=#1引入框架依赖>1.引入框架依赖</a></li><li><a href=#2开启feign功能>2.开启feign功能</a></li><li><a href=#3定义业务client>3.定义业务Client</a></li><li><a href=#4使用业务client>4.使用业务Client</a></li></ul></li><li><a href=#初始化流程>初始化流程</a><ul><li><a href=#流程概览>流程概览</a></li><li><a href=#扫描注册子流程>扫描注册子流程</a></li><li><a href=#生成动态代理子流程>生成动态代理子流程</a></li></ul></li><li><a href=#处理请求流程>处理请求流程</a><ul><li></li></ul></li><li><a href=#对象关系>对象关系</a></li><li><a href=#日常开发问题>日常开发问题</a><ul><li><a href=#q--feignclients中的名字能否一致如果一致会出现什么问题>Q : @FeignClients中的名字能否一致？如果一致会出现什么问题</a></li><li><a href=#q-报错出现重复的feignclientspecification如何解决>Q ：报错"出现重复的FeignClientSpecification"如何解决</a></li><li><a href=#q--报错ambiguousmapping如何解决>Q : 报错"AmbiguousMapping"如何解决</a></li><li><a href=#q--如何配置使用http连接池它们是怎么生效的>Q ： 如何配置使用HTTP连接池？它们是怎么生效的</a></li><li><a href=#q-默认超时配置是多少>Q ：默认超时配置是多少？</a></li><li><a href=#q-feignclient的配置优先级>Q ：feignClient的配置优先级？</a></li></ul></li></ul></nav></div></div></section></div></aside></div></main><footer id=footer class=footer><div class=footer-inner><div class=copyright><span itemprop=copyrightYear>&copy;
2009 - 2022</span>
<span class=with-love><i class="fa fa-heart"></i></span><span class=author itemprop=copyrightHolder></span></div><div class=powered-by>Powered by - <a class=theme-link href=http://gohugo.io target=_blank title=hugo>Hugo v0.68.3</a></div><div class=theme-info>Theme by - <a class=theme-link href=https://github.com/xtfly/hugo-theme-next target=_blank>NexT</a></div></div></footer><div class=back-to-top><i class="fa fa-arrow-up"></i><span id=scrollpercent><span>0</span>%</span></div></div><script type=text/javascript>if(Object.prototype.toString.call(window.Promise)!=='[object Function]'){window.Promise=null;}</script><script type=text/javascript src="https://1162492411.github.io/docs/js/vendor/jquery/index.js?v=2.1.3"></script><script type=text/javascript src="https://1162492411.github.io/docs/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type=text/javascript src="https://1162492411.github.io/docs/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type=text/javascript src="https://1162492411.github.io/docs/js/vendor/velocity/velocity.min.js?v=1.2.1"></script><script type=text/javascript src="https://1162492411.github.io/docs/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="https://1162492411.github.io/docs/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script><script src="https://1162492411.github.io/docs/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script><script type=text/javascript src=https://1162492411.github.io/docs/js/utils.js></script><script type=text/javascript src=https://1162492411.github.io/docs/js/motion.js></script><script type=text/javascript src=https://1162492411.github.io/docs/js/affix.js></script><script type=text/javascript src=https://1162492411.github.io/docs/js/schemes/pisces.js></script><script type=text/javascript src=https://1162492411.github.io/docs/js/scrollspy.js></script><script type=text/javascript src=https://1162492411.github.io/docs/js/post-details.js></script><script type=text/javascript src=https://1162492411.github.io/docs/js/toc.js></script><script type=text/javascript src=https://1162492411.github.io/docs/js/bootstrap.js></script><script type=text/javascript src=https://1162492411.github.io/docs/js/search.js></script><script type=text/x-mathjax-config>
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script></body></html>