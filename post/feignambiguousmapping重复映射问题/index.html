<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>FeignAmbiguousMapping重复映射问题 -</title><meta name=keywords content="zyg,独立,博客,程序员,个人,思考,读书,笔记,技术,分享,java"><meta property="og:title" content="FeignAmbiguousMapping重复映射问题"><meta property="og:site_name" content><meta property="og:image" content="/img/author.jpg"><meta name=title content="FeignAmbiguousMapping重复映射问题 -"><meta name=description content="zyg | 博客 | 软件 |  Java"><link rel="shortcut icon" href=https://1162492411.github.io/docs/img/favicon.ico><link rel=apple-touch-icon href=https://1162492411.github.io/docs/img/apple-touch-icon.png><link rel=apple-touch-icon-precomposed href=https://1162492411.github.io/docs/img/apple-touch-icon.png><link href="https://1162492411.github.io/docs/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel=stylesheet type=text/css><link href="https://1162492411.github.io/docs/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel=stylesheet type=text/css><link href=https://1162492411.github.io/docs/css/main.css rel=stylesheet type=text/css><link href=https://1162492411.github.io/docs/css/syntax.css rel=stylesheet type=text/css><script type=text/javascript id=hexo.configuration>var NexT=window.NexT||{};var CONFIG={scheme:'Pisces',sidebar:{"position":"left","display":"post"},fancybox:true,motion:true};</script></head><body itemscope itemtype=http://schema.org/WebPage lang=zh-hans><div class="container one-collumn sidebar-position-left page-home"><div class=headband></div><header id=header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class="site-meta custom-logo"><div class=custom-logo-site-title><a href=https://1162492411.github.io/docs/ class=brand rel=start><span class=logo-line-before><i></i></span><span class=site-title></span><span class=logo-line-after><i></i></span></a></div><p class=site-subtitle>人生天地间，忽如远行客</p></div><div class=site-nav-toggle><button>
<span class=btn-bar></span><span class=btn-bar></span><span class=btn-bar></span></button></div><nav class=site-nav><ul id=menu class=menu><li class=menu-item><a href=https://1162492411.github.io/docs/ rel=section><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class=menu-item><a href=https://1162492411.github.io/docs/categories/%E6%8A%80%E6%9C%AF/ rel=section><i class="menu-item-icon fa fa-fw fa-code"></i><br>技术</a></li><li class=menu-item><a href=https://1162492411.github.io/docs/categories/%E5%AE%9E%E6%88%98/ rel=section><i class="menu-item-icon fa fa-fw fa-code"></i><br>实战</a></li><li class=menu-item><a href=https://1162492411.github.io/docs/categories/%E7%AC%94%E8%AE%B0/ rel=section><i class="menu-item-icon fa fa-fw fa-book"></i><br>笔记</a></li><li class=menu-item><a href=https://1162492411.github.io/docs/categories/%E9%9D%A2%E8%AF%95%E9%A2%98/ rel=section><i class="menu-item-icon fa fa-fw fa-leaf"></i><br>面试题</a></li><li class=menu-item><a href=https://1162492411.github.io/docs/post/ rel=section><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class=menu-item><a href=https://1162492411.github.io/docs/about/ rel=section><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-search"><a href=javascript:; class=popup-trigger><i class="menu-item-icon fa fa-search fa-fw"></i><br></a></li></ul><div class=site-search><div class=popup><span class="search-icon fa fa-search"></span><input type=text id=local-search-input><div id=local-search-result></div><span class=popup-btn-close>close</span></div></div></nav></div></header><main id=main class=main><div class=main-inner><div class=content-wrap><div id=content class=content><section id=posts class=posts-expand><article class="post post-type-normal" itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline"><a class=post-title-link href=https://1162492411.github.io/docs/post/feignambiguousmapping%E9%87%8D%E5%A4%8D%E6%98%A0%E5%B0%84%E9%97%AE%E9%A2%98/ itemprop=url>FeignAmbiguousMapping重复映射问题</a></h1><div class=post-meta><span class=post-time><span class=post-meta-item-icon><i class="fa fa-calendar-o"></i></span><span class=post-meta-item-text></span><time itemprop=dateCreated datetime=2016-03-22T13:04:35+08:00 content="2022-01-09">2022-01-09</time></span>
<span class=post-category>&nbsp; | &nbsp;
<span class=post-meta-item-icon><i class="fa fa-folder-o"></i></span><span class=post-meta-item-text></span><span itemprop=about itemscope itemtype=https://schema.org/Thing><a href=https://1162492411.github.io/docs/categories/%E5%AE%9E%E6%88%98 itemprop=url rel=index><span itemprop=name>实战</span></a>
&nbsp;</span></span>
<span>&nbsp; | &nbsp;
<span class=post-meta-item-icon><i class="fa fa-eye"></i></span><span class=post-meta-item-text></span><span class=leancloud-visitors-count></span></span></div></header><div class=post-body itemprop=articleBody><h1 id=现象>现象</h1><p>demo服务引入了多个依赖的业务系统(businessA/businessB/&mldr;)的sdk后，启动时FeignClient 报错 Ambiguous mapping 重复映射,报错日志如下:</p><blockquote><p>2022-01-06 15:57:20.267 [main] ERROR [bootstrap,,,] org.springframework.boot.SpringApplication - Application startup failed
org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name &lsquo;documentationPluginsBootstrapper&rsquo; defined in URL
[jar:file:/Users/xxx/.m2/repository/io/springfox/springfox-spring-web/2.9.2/springfox-spring-web-2.9.2.jar!/springfox/documentation/spring/web/plugins/DocumentationPluginsBootstrapper.class]:
Unsatisfied dependency expressed through constructor parameter 1;
nested exception is org.springframework.beans.factory.UnsatisfiedDependencyException:
Error creating bean with name &lsquo;webMvcRequestHandlerProvider&rsquo; defined in URL
[jar:file:/Users/zyg/.m2/repository/io/springfox/springfox-spring-web/2.9.2/springfox-spring-web-2.9.2.jar!/springfox/documentation/spring/web/plugins/WebMvcRequestHandlerProvider.class]:
Unsatisfied dependency expressed through constructor parameter 1;
nested exception is org.springframework.beans.factory.BeanCreationException:
===============Error creating bean with name &lsquo;requestMappingHandlerMapping&rsquo; defined in class path resource
[org/springframework/boot/autoconfigure/web/WebMvcAutoConfiguration$EnableWebMvcConfiguration.class]:
Invocation of init method failed; nested exception is java.lang.IllegalStateException:
===================Ambiguous mapping.
===================Cannot map &lsquo;com.demo.client.feign.UserClient&rsquo; method
public abstract com.BusinessBService.DataResponse&lt;java.util.List&lt;com.xxx.response.UserVO&#187; com.business.b.sdk.api.IUserApi.searchDetail(com.business.b.request.UserDTO)
to {[/user/detail],methods=[POST]}: There is already &lsquo;com.demo.client.BusinessBUserClient&rsquo; bean method
public abstract com.business.response.DataResponse&lt;java.util.List&lt;com.business.b.response.UserVO&#187; com.xx.api.IUserApi.searchDetail(com.business.b.request.UserDetailSearchDTO) mapped.
at org.springframework.beans.factory.support.ConstructorResolver.createArgumentArray(ConstructorResolver.java:749)
at org.springframework.beans.factory.support.ConstructorResolver.autowireConstructor(ConstructorResolver.java:189)
at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.autowireConstructor(AbstractAutowireCapableBeanFactory.java:1198)
at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBeanInstance(AbstractAutowireCapableBeanFactory.java:1100)
at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:511)
at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:481)
at org.springframework.beans.factory.support.AbstractBeanFactory$1.getObject(AbstractBeanFactory.java:312)
at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:230)
at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:308)
at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:197)
at org.springframework.beans.factory.support.DefaultListableBeanFactory.preInstantiateSingletons(DefaultListableBeanFactory.java:761)
at org.springframework.context.support.AbstractApplicationContext.finishBeanFactoryInitialization(AbstractApplicationContext.java:867)
at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:543)
at org.springframework.boot.context.embedded.EmbeddedWebApplicationContext.refresh(EmbeddedWebApplicationContext.java:124)
at org.springframework.boot.SpringApplication.refresh(SpringApplication.java:693)
at org.springframework.boot.SpringApplication.refreshContext(SpringApplication.java:360)
at org.springframework.boot.SpringApplication.run(SpringApplication.java:303)
at org.springframework.boot.SpringApplication.run(SpringApplication.java:1118)
at org.springframework.boot.SpringApplication.run(SpringApplication.java:1107)
at com.xxxx.DemoApplication.main(DemoApplication.java:31)</p></blockquote><p>Maven依赖 :</p><ul><li>spring-boot : 1.5.18.RELEASE</li><li>spring-boot-starter-web : 1.5.18.RELEASE</li><li>spring-cloud-starter-feign : 1.4.6.RELEASE</li></ul><h1 id=业务代码>业务代码</h1><p>报错内容表示是在demo服务中有两个不同服务的Client存在同样的URL,导致SpringMvc部分扫描时因为同一个url下存在多个Method/Handler而启动服务失败。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>//我们自己写的第一个Client
</span><span style=color:#75715e></span><span style=color:#a6e22e>@FeignClient</span><span style=color:#f92672>(</span>name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;BusinessAUserClient&#34;</span><span style=color:#f92672>,</span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${business.a.address}&#34;</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>BusinessAUserFeignClient</span> <span style=color:#66d9ef>extends</span> com<span style=color:#f92672>.</span><span style=color:#a6e22e>business</span><span style=color:#f92672>.</span><span style=color:#a6e22e>a</span><span style=color:#f92672>.</span><span style=color:#a6e22e>UserApi</span><span style=color:#f92672>{</span>
    <span style=color:#75715e>//...
</span><span style=color:#75715e></span><span style=color:#f92672>}</span>

<span style=color:#75715e>//我们第一个Client引用的父类(来自依赖的其他服务BusinessA)
</span><span style=color:#75715e></span><span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>({</span><span style=color:#e6db74>&#34;/user&#34;</span><span style=color:#f92672>})</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>UserApi</span><span style=color:#f92672>{</span>
    <span style=color:#a6e22e>@PostMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/detail&#34;</span><span style=color:#f92672>)</span>
    List<span style=color:#f92672>&lt;</span>UserVo<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>searchDetail</span><span style=color:#f92672>(</span>UserDTO userDTO<span style=color:#f92672>);</span>
    
    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;list&#34;</span><span style=color:#f92672>)</span>
    List<span style=color:#f92672>&lt;</span>UserVo<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getList</span><span style=color:#f92672>(</span>UserDTO userDTO<span style=color:#f92672>);</span>
<span style=color:#f92672>}</span>

<span style=color:#75715e>//我们自己写的第二个Client
</span><span style=color:#75715e></span><span style=color:#a6e22e>@FeignClient</span><span style=color:#f92672>(</span>name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;BusinessBUserClient&#34;</span><span style=color:#f92672>,</span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${business.b.address}&#34;</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>BusinessBUserFeignClient</span> <span style=color:#66d9ef>extends</span> com<span style=color:#f92672>.</span><span style=color:#a6e22e>business</span><span style=color:#f92672>.</span><span style=color:#a6e22e>b</span><span style=color:#f92672>.</span><span style=color:#a6e22e>UserApi</span><span style=color:#f92672>{</span>
    <span style=color:#75715e>//...
</span><span style=color:#75715e></span><span style=color:#f92672>}</span>

<span style=color:#75715e>//我们第二个Client引用的父类(来自依赖的其他服务BusinessB)
</span><span style=color:#75715e></span><span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>({</span><span style=color:#e6db74>&#34;/user&#34;</span><span style=color:#f92672>})</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>UserApi</span><span style=color:#f92672>{</span>
    <span style=color:#a6e22e>@PostMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/detail&#34;</span><span style=color:#f92672>)</span>
    List<span style=color:#f92672>&lt;</span>UserVo<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>searchDetail</span><span style=color:#f92672>(</span>UserDTO userDTO<span style=color:#f92672>);</span>
<span style=color:#f92672>}</span>
</code></pre></div><blockquote><p>疑问1 : 为什么FeignClient会被SpringMVC扫描??
疑问2 : 平常我们自己写的各种@FeignClient的类是如何被Spring扫描到的
疑问3 : 如果是所有依赖服务的URL都被当做我们自己服务的URL进行扫描，那么每个服务都存在health/check接口，为什么这些地方不会报错</p></blockquote><h1 id=feignspringmvc扫描---相关代码定位>Feign+SpringMVC扫描 - 相关代码定位</h1><p>首先我们怀疑一下是SpringMVC的扫描存在问题,从这方面入手,我们查看一下@RequestMapping的类是如何被处理的,省略中间过程,最终查找到如下代码</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RequestMappingHandlerMapping</span> <span style=color:#f92672>{</span>

    <span style=color:#75715e>/**
</span><span style=color:#75715e>     * {@inheritDoc}
</span><span style=color:#75715e>     * &lt;p&gt;Expects a handler to have either a type-level @{@link Controller}
</span><span style=color:#75715e>     * annotation or a type-level @{@link RequestMapping} annotation.
</span><span style=color:#75715e>     */</span>
    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isHandler</span><span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;?&gt;</span> beanType<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>AnnotatedElementUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>hasAnnotation</span><span style=color:#f92672>(</span>beanType<span style=color:#f92672>,</span> Controller<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>||</span>
                AnnotatedElementUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>hasAnnotation</span><span style=color:#f92672>(</span>beanType<span style=color:#f92672>,</span> RequestMapping<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>));</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>那么原因就是各个依赖的UserApi等类存在@RequestMapping注解,所以SpringMVC顺手进行了扫描</p><h1 id=feignspringmvc扫描---解决思路>Feign+SpringMVC扫描 - 解决思路</h1><p>既然根源在于被SpringMVC额外扫描了，那么我们可以想办法让其不被SpringMVC扫描(但是最好仍然交给Spring托管xxxFeignClient)</p><h2 id=方案一--手动写url>方案一 : 手动写URL</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>//我们自己写的第一个Client(这个类不再继承com.business.a.UserApi)
</span><span style=color:#75715e></span><span style=color:#a6e22e>@FeignClient</span><span style=color:#f92672>(</span>name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;BusinessAUserClient&#34;</span><span style=color:#f92672>,</span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${business.a.address}&#34;</span><span style=color:#f92672>,</span>path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/user&#34;</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>BusinessAUserFeignClient</span><span style=color:#f92672>{</span>
    
    <span style=color:#a6e22e>@PostMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/detail&#34;</span><span style=color:#f92672>)</span>
    List<span style=color:#f92672>&lt;</span>UserVo<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>searchDetail</span><span style=color:#f92672>(</span>UserDTO userDTO<span style=color:#f92672>);</span>

    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/list&#34;</span><span style=color:#f92672>)</span>
    List<span style=color:#f92672>&lt;</span>UserVo<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getList</span><span style=color:#f92672>(</span>UserDTO userDTO<span style=color:#f92672>);</span>
    
<span style=color:#f92672>}</span>

<span style=color:#75715e>//我们自己写的第二个Client(这个类可以仍然继承com.business.b.UserApi,也可以像BusinessAUserFeignClient一样手写url)
</span><span style=color:#75715e></span><span style=color:#a6e22e>@FeignClient</span><span style=color:#f92672>(</span>name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;BusinessBUserClient&#34;</span><span style=color:#f92672>,</span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${business.b.address}&#34;</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>BusinessBUserFeignClient</span> <span style=color:#66d9ef>extends</span> com<span style=color:#f92672>.</span><span style=color:#a6e22e>business</span><span style=color:#f92672>.</span><span style=color:#a6e22e>b</span><span style=color:#f92672>.</span><span style=color:#a6e22e>UserApi</span><span style=color:#f92672>{</span>
    <span style=color:#75715e>//...
</span><span style=color:#75715e></span><span style=color:#f92672>}</span>

<span style=color:#75715e>//我们第二个Client引用的父类(来自依赖的其他服务BusinessB)
</span><span style=color:#75715e></span><span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>({</span><span style=color:#e6db74>&#34;/user&#34;</span><span style=color:#f92672>})</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>UserApi</span><span style=color:#f92672>{</span>
    <span style=color:#a6e22e>@PostMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/detail&#34;</span><span style=color:#f92672>)</span>
    List<span style=color:#f92672>&lt;</span>UserVo<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>searchDetail</span><span style=color:#f92672>(</span>UserDTO userDTO<span style=color:#f92672>);</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>这样一来,最多有一个url的Handler被SpringMVC扫描，服务可以正常启动，代码也可以正常调用这几个url。
但是,这样一来,我们就无法享受到依赖服务SDK的好处了,如果依赖服务后期新增/改动了url/改动了url中的请求或相应类,我们这边都要进行相应修改;如果要求
依赖服务方将UserApi的类级别的@RequestMapping移动到各方法中也有些强人所难且不合理</p><h2 id=方案二--springmvc扫描时过滤>方案二 : SpringMVC扫描时过滤</h2><p>既然问题出在SpringMVC扫描,那么如果我们修改isHandler()的逻辑,使其在遇到@FeignClient的类时忽略,也能达到我们想要的效果</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>//代码拷贝自https://github.com/spring-cloud/spring-cloud-netflix/issues/466#issuecomment-257043631
</span><span style=color:#75715e></span><span style=color:#f92672>import</span> feign.Feign<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnClass<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.springframework.boot.autoconfigure.web.WebMvcRegistrations<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.springframework.boot.autoconfigure.web.WebMvcRegistrationsAdapter<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.springframework.cloud.netflix.feign.FeignClient<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.springframework.context.annotation.Bean<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.springframework.context.annotation.Configuration<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.springframework.core.annotation.AnnotationUtils<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping<span style=color:#f92672>;</span>

<span style=color:#75715e>/**
</span><span style=color:#75715e> * 解决带有@FeignClient的类继承了类级别带有@RequestMapping的API类之后被springmvc扫描handlerMapping的问题
</span><span style=color:#75715e> * @author xxx
</span><span style=color:#75715e> */</span>
<span style=color:#a6e22e>@Configuration</span>
<span style=color:#a6e22e>@ConditionalOnClass</span><span style=color:#f92672>({</span>Feign<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>})</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FeignMappingDefaultConfiguration</span> <span style=color:#f92672>{</span>
    <span style=color:#a6e22e>@Bean</span>
    <span style=color:#66d9ef>public</span> WebMvcRegistrations <span style=color:#a6e22e>feignWebRegistrations</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> WebMvcRegistrationsAdapter<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
            <span style=color:#a6e22e>@Override</span>
            <span style=color:#66d9ef>public</span> RequestMappingHandlerMapping <span style=color:#a6e22e>getRequestMappingHandlerMapping</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> FeignFilterRequestMappingHandlerMapping<span style=color:#f92672>();</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>};</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FeignFilterRequestMappingHandlerMapping</span> <span style=color:#66d9ef>extends</span> RequestMappingHandlerMapping <span style=color:#f92672>{</span>
        <span style=color:#a6e22e>@Override</span>
        <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isHandler</span><span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;?&gt;</span> beanType<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isHandler</span><span style=color:#f92672>(</span>beanType<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>(</span>AnnotationUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>findAnnotation</span><span style=color:#f92672>(</span>beanType<span style=color:#f92672>,</span> FeignClient<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h2 id=方案三--官方解决方案>方案三 : 官方解决方案</h2><p>Spring官方(Spring-framework)相关开发经过讨论,最终给出的<a href=https://github.com/spring-projects/spring-framework/issues/22154#issuecomment-936906502>解决方案</a>是</p><blockquote><p>2021-10-7
after some cross-team discussions, for the short term the issue will be addressed on the side of Spring Data REST and Spring Cloud.
For Spring Framework 6.0, we will also address this in the Spring Framework by no longer considering a class with a
type-level @RequestMapping as a candidate for detection, unless there is also @Controller.
经过一些跨团队讨论，短期内该问题将在 Spring Data REST 和 Spring Cloud 方面解决。
对于 Spring Framework 6.0，我们还将在 Spring Framework 中解决这个问题，不再将具有类型级别的类@RequestMapping作为检测候选，除非也有@Controller.</p></blockquote><p>具体代码如下</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RequestMappingHandlerMapping</span> <span style=color:#f92672>{</span>
  
  <span style=color:#75715e>//只将类级别有@Controller的进行扫描,这样改整体看合理但是不向前兼容
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isHandler</span><span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;?&gt;</span> beanType<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
		<span style=color:#66d9ef>return</span> AnnotatedElementUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>hasAnnotation</span><span style=color:#f92672>(</span>beanType<span style=color:#f92672>,</span> Controller<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
	<span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>Spring-cloud-openfeign的<a href=https://github.com/spring-cloud/spring-cloud-openfeign/issues/547>解决方案</a>是不支持@FeignClient+@RequestMapping,
具体代码为https://github.com/spring-cloud/spring-cloud-openfeign/commit/d6783a6f1ec8dd08fafe76ecd072913d4e6f66b9</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SpringMvcContract</span> <span style=color:#66d9ef>extends</span> Contract<span style=color:#f92672>.</span><span style=color:#a6e22e>BaseContract</span>
		<span style=color:#66d9ef>implements</span> ResourceLoaderAware <span style=color:#f92672>{</span>

	<span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>processAnnotationOnClass</span><span style=color:#f92672>(</span>MethodMetadata data<span style=color:#f92672>,</span> Class<span style=color:#f92672>&lt;?&gt;</span> clz<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
			RequestMapping classAnnotation <span style=color:#f92672>=</span> findMergedAnnotation<span style=color:#f92672>(</span>clz<span style=color:#f92672>,</span>
					RequestMapping<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
			<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>classAnnotation <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
				LOG<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Cannot process class: &#34;</span> <span style=color:#f92672>+</span> clz<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span>
						<span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;. @RequestMapping annotation is not allowed on @FeignClient interfaces.&#34;</span><span style=color:#f92672>);</span>
				<span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span>
						<span style=color:#e6db74>&#34;@RequestMapping annotation not allowed on @FeignClient interfaces&#34;</span><span style=color:#f92672>);</span>
   <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>   
</code></pre></div></div><footer class=post-footer><div class=post-tags><a href=https://1162492411.github.io/docs/tags/java rel=tag title=Java>#Java#</a>
<a href=https://1162492411.github.io/docs/tags/feign rel=tag title=Feign>#Feign#</a>
<a href=https://1162492411.github.io/docs/tags/feign%e5%ae%9e%e6%88%98 rel=tag title=Feign实战>#Feign实战#</a></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=https://1162492411.github.io/docs/post/feign%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ rel=next title=Feign源码分析><i class="fa fa-chevron-left"></i>Feign源码分析</a></div><div class="post-nav-prev post-nav-item"><a href=https://1162492411.github.io/docs/post/es%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4api/ rel=prev title=Es批量删除api>Es批量删除api <i class="fa fa-chevron-right"></i></a></div></div></footer></article></section></div></div><div class=sidebar-toggle><div class=sidebar-toggle-line-wrap><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id=sidebar class=sidebar><div class=sidebar-inner><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target=post-toc-wrap></li><li class=sidebar-nav-overview data-target=site-overview></li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image src=https://1162492411.github.io/docs/img/author.jpg alt=zyg><p class=site-author-name itemprop=name>zyg</p><p class="site-description motion-element" itemprop=description>Programmer & Architect</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href=https://1162492411.github.io/docs/post/><span class=site-state-item-count>28</span>
<span class=site-state-item-name></span></a></div><div class="site-state-item site-state-categories"><a href=https://1162492411.github.io/docs/categories/><span class=site-state-item-count>27</span>
<span class=site-state-item-name></span></a></div><div class="site-state-item site-state-tags"><a href=https://1162492411.github.io/docs/tags/><span class=site-state-item-count>47</span>
<span class=site-state-item-name></span></a></div></nav><div class="links-of-author motion-element"><span class=links-of-author-item><a href=https://github.com/1162492411/ target=_blank title=GitHub><i class="fa fa-fw fa-github"></i>GitHub</a></span></div><div class="links-of-blogroll motion-element inline"><script type=text/javascript src="//rf.revolvermaps.com/0/0/8.js?i=5b4f2ucxar6&m=0&s=220&c=ff0000&cr1=ffffff&f=arial&l=33&bv=35" async></script></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class=post-toc><div class=post-toc-content><nav id=TableOfContents><ul><li><a href=#方案一--手动写url>方案一 : 手动写URL</a></li><li><a href=#方案二--springmvc扫描时过滤>方案二 : SpringMVC扫描时过滤</a></li><li><a href=#方案三--官方解决方案>方案三 : 官方解决方案</a></li></ul></nav></div></div></section></div></aside></div></main><footer id=footer class=footer><div class=footer-inner><div class=copyright><span itemprop=copyrightYear>&copy;
2009 - 2022</span>
<span class=with-love><i class="fa fa-heart"></i></span><span class=author itemprop=copyrightHolder></span></div><div class=powered-by>Powered by - <a class=theme-link href=http://gohugo.io target=_blank title=hugo>Hugo v0.68.3</a></div><div class=theme-info>Theme by - <a class=theme-link href=https://github.com/xtfly/hugo-theme-next target=_blank>NexT</a></div></div></footer><div class=back-to-top><i class="fa fa-arrow-up"></i><span id=scrollpercent><span>0</span>%</span></div></div><script type=text/javascript>if(Object.prototype.toString.call(window.Promise)!=='[object Function]'){window.Promise=null;}</script><script type=text/javascript src="https://1162492411.github.io/docs/js/vendor/jquery/index.js?v=2.1.3"></script><script type=text/javascript src="https://1162492411.github.io/docs/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type=text/javascript src="https://1162492411.github.io/docs/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type=text/javascript src="https://1162492411.github.io/docs/js/vendor/velocity/velocity.min.js?v=1.2.1"></script><script type=text/javascript src="https://1162492411.github.io/docs/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="https://1162492411.github.io/docs/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script><script src="https://1162492411.github.io/docs/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script><script type=text/javascript src=https://1162492411.github.io/docs/js/utils.js></script><script type=text/javascript src=https://1162492411.github.io/docs/js/motion.js></script><script type=text/javascript src=https://1162492411.github.io/docs/js/affix.js></script><script type=text/javascript src=https://1162492411.github.io/docs/js/schemes/pisces.js></script><script type=text/javascript src=https://1162492411.github.io/docs/js/scrollspy.js></script><script type=text/javascript src=https://1162492411.github.io/docs/js/post-details.js></script><script type=text/javascript src=https://1162492411.github.io/docs/js/toc.js></script><script type=text/javascript src=https://1162492411.github.io/docs/js/bootstrap.js></script><script type=text/javascript src=https://1162492411.github.io/docs/js/search.js></script><script type=text/x-mathjax-config>
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script></body></html>